{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Avatar Section -->
    <section class="avatar-section">
        <div class="avatar-container">
            <div class="avatar">
                üòä
            </div>
            <p class="avatar-message">
                Let's track your day together!
            </p>

            <!-- Streak Display -->
            {% if progress['current_streak'] > 0 %}
            <div class="streak-badge">
                üî• {{ progress['current_streak'] }} day streak!
            </div>
            {% endif %}
        </div>
    </section>

    <!-- NEW: Progress & Gamification Section -->
    <section class="progress-section">
        <div class="progress-grid">
            <!-- Weekly Consistency Tracker -->
            <div class="progress-card">
                <h3 class="progress-title">Weekly Consistency</h3>
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: 70%"></div>
                </div>
                <p class="progress-text">Keep logging daily!</p>
            </div>

            <!-- Total Logs Counter -->
            <div class="progress-card">
                <h3 class="progress-title">Total Logs</h3>
                <div class="progress-stat">
                    <span class="stat-number">{{ progress['total_logs'] }}</span>
                    <span class="stat-label">entries recorded</span>
                </div>
            </div>

            <!-- Longest Streak -->
            <div class="progress-card">
                <h3 class="progress-title">Personal Best</h3>
                <div class="progress-stat">
                    <span class="stat-number">{{ progress['longest_streak'] }}</span>
                    <span class="stat-label">day longest streak</span>
                </div>
            </div>
        </div>

        <!-- Earned Badges -->
        {% if progress['badges'] and progress['badges'][0] %}
        <div class="badges-section">
            <h3 class="subsection-title">Your Badges</h3>
            <div class="badges-grid">
                {% for badge_id in progress['badges'] %}
                {% if badge_id %}
                <div class="badge-item">
                    <span class="badge-icon">
                        {% if badge_id == 'first_log' %}üå±
                        {% elif badge_id == 'streak_3' %}üî•
                        {% elif badge_id == 'streak_7' %}‚≠ê
                        {% elif badge_id == 'streak_30' %}üèÜ
                        {% elif badge_id == 'logs_50' %}üìä
                        {% elif badge_id == 'logs_100' %}üíØ
                        {% else %}üéñÔ∏è
                        {% endif %}
                    </span>
                    <div class="badge-info">
                        <strong>
                            {% if badge_id == 'first_log' %}Getting Started
                            {% elif badge_id == 'streak_3' %}3-Day Streak
                            {% elif badge_id == 'streak_7' %}Week Warrior
                            {% elif badge_id == 'streak_30' %}Monthly Champion
                            {% elif badge_id == 'logs_50' %}Data Collector
                            {% elif badge_id == 'logs_100' %}Century Club
                            {% else %}Achievement
                            {% endif %}
                        </strong>
                        <small>Well done!</small>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </section>

    <!-- NEW: Tip of the Day -->
    <section class="tip-section">
        <div class="tip-card">
            <div class="tip-header">
                <span class="tip-icon">üí°</span>
                <h3 class="tip-title">Tip of the Day</h3>
            </div>
            <p class="tip-content">{{ daily_tip.tip }}</p>
        </div>
    </section>

    <!-- Weekly Glucose Trend Chart -->
    {% if chart_data and chart_data.labels %}
    <section class="chart-section">
        <h2 class="section-title">Your Weekly Glucose Trend</h2>
        <div class="chart-container">
            <canvas id="glucoseChart"></canvas>
        </div>
    </section>
    {% endif %}

    <!-- Recent Entries -->
    <section class="recent-entries-section">
        <h2 class="section-title">Recent Logs</h2>
        {% if entries %}
            <div class="entries-grid">
                {% for entry in entries[:6] %}
                <div class="entry-card">
                    <div class="entry-header">
                        <span class="entry-time">{{ entry.timestamp.strftime('%b %d, %I:%M %p') }}</span>
                        <span class="entry-mood-icon">
                            {% if entry.mood == 'happy' %}üòä
                            {% elif entry.mood == 'calm' %}üòå
                            {% elif entry.mood == 'stressed' %}üò∞
                            {% elif entry.mood == 'tired' %}üò¥
                            {% elif entry.mood == 'frustrated' %}üò§
                            {% else %}üôÇ
                            {% endif %}
                        </span>
                    </div>
                    <div class="entry-glucose">
                        <strong>{{ entry.blood_glucose }}</strong> mmol/L
                    </div>
                    <div class="entry-meal">
                        Meal: <span class="meal-tag">{{ entry.meal_type.capitalize() }}</span>
                    </div>
                    {% if entry.notes %}
                    <div class="entry-notes">
                        "{{ entry.notes }}"
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <p>No entries yet. <a href="{{ url_for('log_entry') }}" class="link-primary">Start logging</a> to see your trends!</p>
            </div>
        {% endif %}
    </section>

    <!-- Quick Action Button -->
    <div class="quick-action">
        <a href="{{ url_for('log_entry') }}" class="btn btn-primary btn-large">
            ‚ûï Log New Entry
        </a>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
{% if chart_data and chart_data.labels %}
<script>
    // Chart.js configuration for glucose trend
    const ctx = document.getElementById('glucoseChart').getContext('2d');

    const chartData = {
        labels: {{ chart_data.labels | tojson }},
        datasets: [{
            label: 'Blood Glucose (mmol/L)',
            data: {{ chart_data.glucose | tojson }},
            borderColor: '#4A90E2',
            backgroundColor: 'rgba(74, 144, 226, 0.1)',
            borderWidth: 3,
            tension: 0.4,
            fill: true,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: '#4A90E2',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
        }]
    };

    const config = {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: {
                            size: 14,
                            family: "'Inter', sans-serif"
                        },
                        color: '#2C3E50'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(44, 62, 80, 0.9)',
                    padding: 12,
                    titleFont: {
                        size: 14
                    },
                    bodyFont: {
                        size: 13
                    },
                    borderColor: '#4A90E2',
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    min: 3.0,
                    max: 15.0,
                    ticks: {
                        font: {
                            size: 12
                        },
                        color: '#7F8C8D'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 12
                        },
                        color: '#7F8C8D'
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    };

    new Chart(ctx, config);
</script>
{% endif %}
{% endblock %}